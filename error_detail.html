<!DOCTYPE html>
<html lang="en">
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=2.0">
    <title>BI Document Detail {{ error.error_number }} </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="{{ url_for('static', filename='images/logo1.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <!-- Custom CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="{{ url_for('static', filename='fontawesomefree/css/fontawesome.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='fontawesomefree/css/brands.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='fontawesomefree/css/solid.css') }}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
/* General Styles */
body {
    font-family: 'Roboto', sans-serif;
    background-color: #f0f0f0;
    margin: 0;
    padding: 0;
}
/* Modal Styles */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
}

/* Caption of Modal */
#caption {
    margin: 10px auto;
    text-align: center;
    color: #ccc;
    font-size: 12px;
}

/* The Close Button */
.close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
}

/* Navigation Buttons */
.nav-button {
    cursor: pointer;
    position: absolute;
    top: 50%;
    width: auto;
    padding: 16px;
    color: #f1f1f1;
    font-weight: bold;
    font-size: 18px;
    border-radius: 3px;
    user-select: none;
    background-color: rgba(0,0,0,0.8);
}

.prev {
    left: 0;
}

.next {
    right: 0;
}

.container {
    background-color: #ffffff;
    margin-top: 20px;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Zoom Effect */
.zoom {
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.9);
    transition: transform 0.3s ease-in-out;
    width: 100%;
    height: 100%;
    margin: 0 auto;
    border-radius: 8px;
}

.zoom:hover {
    transform: scale(1.05);
}

/* Styled Dropdown */
.styled-dropdown {
    margin-bottom: 15px;
}

.styled-dropdown select {
    width: 100%;
    font-size: 16px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #fff;
    color: #333;
}

/* Alerts */
.alert-container {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 300px;
    z-index: 9999;
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-end;
    pointer-events: none;
}

.alert {
    width: 100%;
    padding: 15px;
    margin-top: 10px;
    background-color: #fff;
    color: #333;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: opacity 0.3s ease;
    opacity: 1;
}

.alert.success {
    background-color: #4caf50;
    color: #fff;
}

.alert.info {
    background-color: #2196f3;
    color: #fff;
}

.alert.warning {
    background-color: #ff9800;
    color: #fff;
}

/* Close Button */
.closebtn {
    margin-left: 15px;
    color: white;
    font-weight: bold;
    float: right;
    font-size: 22px;
    cursor: pointer;
    transition: color 0.3s;
}

.closebtn:hover {
    color: #000;
}

/* Navigation */
nav {
    background-color: #333;
    padding: 10px 0;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

nav ul {
    list-style-type: none;
    padding: 0;
}

nav ul li {
    display: inline;
    margin-right: 20px;
}

nav ul li a {
    color: #fff;
    text-decoration: none;
    font-size: 16px;
    transition: color 0.3s ease;
}

nav ul li a:hover {
    color: #f0f0f0;
}

/* Footer */
footer {
    text-align: center;
    padding: 20px;
    background-color: #333;
    color: #fff;
}

/* Form Controls */
.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
}

/* Buttons */
.btn-primary {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s ease;
}

.btn-primary:hover {
    background-color: #0056b3;
}

/* Chat and Messages */
.chat {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.delete-message {
    color: red;
    cursor: pointer;
}

.chat-image-thumbnail {
    max-width: 200px;
    max-height: 200px;
    border: 2px solid #000000;
    border-radius: 10px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.chat-image-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Modal Container */
.modal {
    display: none; /* Hide modal by default */
    position: fixed; /* Use fixed positioning to center the modal */
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0); /* Background color of modal */
    background-color: rgba(0,0,0,0.8); /* Semi-transparent background */
}

/* Modal Content (Image) */
.modal-content {
    display: block;
    margin: auto;
    max-width: 90%;
    max-height: 80vh; /* Limit height to avoid overflow */
    object-fit: contain; /* Maintain aspect ratio */
    transition: transform 0.25s ease; /* Smooth scaling effect */
}

/* Zoom Controls */
.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.zoom-button {
    padding: 10px;
    font-size: 20px;
    color: white;
    background-color: rgba(0, 0, 0, 0.5);
    border: none;
    cursor: pointer;
    border-radius: 3px;
}

.zoom-button:hover {
    background-color: rgba(0, 0, 0, 0.8);
}

.close {
    position: absolute;
    top: 20px; /* Position from the top */
    right: 20px; /* Position from the right */
    color: white; /* Close button color */
    font-size: 30px; /* Close button size */
    font-weight: bold; /* Close button weight */
    cursor: pointer; /* Pointer on hover */
    z-index: 1001; /* Ensure it is on top of the image */
}
.nav-button {
    position: absolute;
    top: 50%; /* Center vertically */
    transform: translateY(-50%); /* Adjust for vertical centering */
    color: white; /* Button color */
    font-size: 30px; /* Button size */
    font-weight: bold; /* Button weight */
    cursor: pointer; /* Pointer on hover */
    background-color: rgba(255, 255, 255, 0.3); /* Semi-transparent background */
    width: 50px; /* Fixed width for perfect circular shape */
    height: 50px; /* Fixed height for perfect circular shape */
    border-radius: 50%; /* Make buttons circular */
    display: flex; /* Use flexbox to center content */
    align-items: center; /* Center vertically */
    justify-content: center; /* Center horizontally */
    transition: background-color 0.2s; /* Smooth background change */
}

.prev {
    left: 20px; /* Position to the left */
}

.next {
    right: 20px; /* Position to the right */
}

.prev:hover, .next:hover {
    background-color: rgba(255, 255, 255, 0.5); /* Change background on hover */
}



/* Loading Spinner */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading-spinner {
    border: 16px solid #f3f3f3;
    border-top: 16px solid #007bff;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Tooltips */
.tooltip-button {
    position: relative;
    display: inline-block;
}

.tooltip-text {
    visibility: hidden;
    width: 120px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 5px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -60px;
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip-button:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    width: 300px;
}

.toast {
    position: relative;
    background-color: #333;
    color: #fff;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

.toast.show {
    opacity: 1;
}

.toast-progress {
    height: 4px;
    background-color: #007bff;
    width: 0%;
    position: absolute;
    bottom: 0;
    left: 0;
    border-radius: 0 0 5px 5px;
}
.file-icon {
    width: 60px; /* Adjust the size of the icon */
    height: auto; /* Maintain the aspect ratio */
    vertical-align: middle; /* Align icon with text */
    margin-right: 8px; /* Space between icon and file name */
}


    </style>
</head>
<body>


    
    
    <header>

        <div class="banner justify-content-end">
            <h1 class="mb-4 mt-4 ml-0 mr-4 text-center">BI Navision Helpdesk Detail</h1>


                

            <div class="controlbt d-flex justify-content-end">
                
                <form action="{{ url_for('my_tasks')}}" method="get" class="d-inline mr-2">
                    <button id="print-button" type="submit" class="btn btn-link"><i class="fa-solid fa-arrow-left" style="font-size:28px;color:rgb(0, 0, 0)"></i></button>
                    <button id="print-button" class="btn btn-link " onclick="window.print()"><i class="fa-solid fa-print" style="font-size:28px;color:rgb(0, 0, 0)"></i></button>
                    <div id="google_translate_element"></div>
                </form>

            </div>
        </div> 

    </header>        
    <div class="container">
            <!-- ส่วนของ Tickets (ซ้าย) -->
        <div>

                <!-- Iterate through tickets -->
                <div class="ticket border p-8 mb-4">
                    <h2 class="text-primary" style="background-color: #c3e4ff; text-align: center; height: 55px;"><strong>Document No :</strong> {{ error.error_number }}</h2>
                    <!-- Ticket details -->
                    <div class="row">
                        <div class="col-md-6">
                            
                            <h5 class="text-primary mb-3"><strong>Name Request :</strong> {{error.title }}</h5>
                            
                            <div class="dropdown mt-1">
                                <div class="styled-dropdown" style="display: flex;">
                                    <label for="status-select" class="{% if error.status == 'open' %}red-text{% elif error.status == 'In Progress' %}yellow-text{% else %}green-text{% endif %}">
                                        <strong>Status : </strong>{{ error.status }}
                                    </label>
                                    {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                                        {% if error.status not in ['Finish', 'In Progress', 'Wait for Requester', 'Wait for Admin'] %}
                                            <form id="status-form" action="{{ url_for('update_status_error', error_id=error_id) }}" method="POST">
                                                <input type="hidden" name="status" value="In Progress">
                                                <a href="#" class="small Link ml-4" onclick="submitForm(this.closest('form'))">Change to In Progress</a>
                                            </form>
                                        {% endif %}
                                        {% if error.status in ['In Progress', 'Wait for Admin'] %}
                                            <form action="{{ url_for('update_status_error', error_id=error_id) }}" method="POST" class="ml-4">
                                                <input type="hidden" name="nowerror_status" value="Wait for Requester">
                                                <a href="#" class="small Link" onclick="submitForm(this.closest('form'))">Send to Requester</a>
                                            </form>                                        
                                        {% endif %}
                                    {% elif 'user' in current_user.roles %}
                                        {% if error.status == 'Wait for Requester' %}
                                            <form action="{{ url_for('update_status_error', error_id=error_id) }}" method="POST" class="ml-4">
                                                <input type="hidden" name="nowerror_status" value="Wait for Admin">
                                                <a href="#" class="small Link" onclick="submitForm(this.closest('form'))">Send to Admin</a>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            
                            {% if error.status not in ['Finish'] %}
                            {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                                <label class="mb-3" for="priority"><strong>Priority :</strong></label>
                                <select class="ml-3" style="width: 200px; height: 30px;" id="priority" name="priority" required onchange="updateErrorOrder('{{ error.id }}', 'priority', this.value)">
                                    <option value="" {% if error.priority == '' %}selected{% endif %}>--select--</option>
                                    <option value="Low" {% if error.priority == 'Low' %}selected{% endif %}>Low</option>
                                    <option value="Medium" {% if error.priority == 'Medium' %}selected{% endif %}>Medium</option>
                                    <option value="High" {% if error.priority == 'High' %}selected{% endif %}>High</option>
                                </select>
                            {% else %}
                                <p><strong>Priority :</strong> {{ error.priority }}</p>
                            {% endif %}
                        
                            {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                                <div style="display: flex;">
                                    <label class="mb-3" for="issuetype"><strong>Issue Type :</strong></label>
                                    <select class="ml-3" style="width: 200px; height: 30px;" id="issuetype" name="issuetype" required onchange="updateErrorOrder('{{ error.id }}', 'issuetype', this.value)">
                                        <option value="" {% if error.issuetype == '' %}selected{% endif %}>--select--</option>
                                        <option value="SoftwareError" {% if error.issuetype == 'SoftwareError' %}selected{% endif %}>SoftwareError</option>
                                        <option value="UserError" {% if error.issuetype == 'UserError' %}selected{% endif %}>UserError</option>
                                        <option value="OtherIssue" {% if error.issuetype == 'OtherIssue' %}selected{% endif %}>OtherIssue</option>
                                
                                    </select>
                                </div>
                            {% else %}
                                <p><strong>Issue Type :</strong> {{ error.issuetype }}</p>
                            {% endif %}
                        
                            {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                                <div style="display: flex;">
                                    <label class="mb-3" for="job_by"><strong>Responsible :</strong></label>
                                    <select class="ml-3" style="width: 200px; height: 30px;" id="job_by" name="job_by" required onchange="updateResponsible('{{ error.id }}', 'job_by', this.value)">
                                        <option value="" {% if error.job_by == '' %}selected{% endif %}>--select--</option>
                                        <option value="Kamonchanok Thamprasert (Smile)" {% if error.job_by == 'Kamonchanok Thamprasert (Smile)' %}selected{% endif %}>Smile</option>
                                        <option value="Wanitcha Adam (Hig)" {% if error.job_by == 'Wanitcha Adam (Hig)' %}selected{% endif %}>Hig</option>
                                        <option value="Patinut Pratumma  (Noon)" {% if error.job_by == 'Patinut Pratumma  (Noon)' %}selected{% endif %}>Noon</option>
                                        <option value="Wasinee Tamaprasert  (Ying)" {% if error.job_by == 'Wasinee Tamaprasert  (Ying)' %}selected{% endif %}>Ying</option>
                                    </select>
                                </div>
                            {% else %}
                                <p><strong>Responsible :</strong> {{ error.job_by }}</p>
                            {% endif %}
                        {% else %}
                            <p><strong>Priority :</strong> {{ error.priority }}</p>
                            <p><strong>Issue Type :</strong> {{ error.issuetype }}</p>
                            <p><strong>Responsible :</strong> {{ error.job_by }}</p>
                        {% endif %}
                        
                        </div>
                        <div class="col-md-6">
                            <p><strong>Department :</strong> {{ error.department }}</p>
                            <p><strong>Description :</strong> {{ error.description }}</p>

                            <p><strong>Solution : </strong>{{ error.reason }}</p>
                            <p><strong>Created at : </strong>{{ error.created_at }}</p>
                            {% if error.status not in ['Pending', 'In Progress', 'Wait for Requester', 'Wait for Admin'] %}
                            <p><strong>Finished at :</strong> {{error.close_at }}</p>
                            
                            {% endif %} 
                        </div>
                    </div>     
                    <div class="chat-log ticket border p-4">
                        <h4 class="small"><strong>Operation details for Error No :</strong> {{ error.error_number }}</h4>
                        <div class="chat" id="chat_box_{{ error.id }}">
                            {% set messages_found = false %}
                            {% if chat_messages is not defined or chat_messages|length == 0 %}
                                <p class="small text-muted mt-2">No Chat History</p>
                            {% else %}
                                {% for message in chat_messages %}
                                    {% if message.error_id == error.id %}
                                        <p id="message_{{ message.id }}" class="white-bg mt-1 mb-1 message-container zoom">
                                            {% if message.image_user %}
                                                <img src="{{ message.image_user }}" class="chat-user-image" style="width: 40px; height: 40px; border-radius: 50%;" />
                                            {% endif %}
                                            <strong>{{ message.sender }}:</strong> {{ message.message }}
                        
                                            {% if message.image_path %}
                                                <img style="border-color: #000000;" src="{{ url_for('static', filename='uploads/' + message.image_path.split('/')[-1]) }}" class="chat-image-thumbnail image-container border" onclick="viewFullImage('{{ url_for('static', filename='uploads/' + message.image_path.split('/')[-1]) }}')" />
                                            {% endif %}
                        
                                            {% if message.document_path %}
                                            {% set filename = message.document_path.split('/')[-1] %}  {# Extract the file name from the path #}
                                            {% set file_extension = filename.split('.')[-1].lower() %}  {# Extract and lowercase the file extension #}
                                            
                                            <a href="{{ url_for('static', filename='uploads/' + message.document_path) }}" class="chat-document-link" target="_blank">
                                                {% if file_extension in ['xls', 'xlsx'] %}
                                                    <!-- Display Excel icon for Excel files -->
                                                    <img src="{{ url_for('static', filename='icons/excel-icon.png') }}" alt="Excel Icon" class="file-icon">

                                                {% endif %}
                                                {{ filename }}  {# Display the file name #}
                                            </a>
                                        {% endif %}
                                        
                                        
                        
                                            <small>({{ message.timestamp }})</small>
                                            {% if error.status in ['Pending', 'in_progress', 'Wait for Requester', 'Wait for Admin'] %}
                                                <span class="delete-message small" onclick="deleteMessage('{{ message.id }}')">delete</span>
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                    
                        {% if not messages_found %}
                        {% endif %}
                        {% if error.status != 'Finish' %}
                        <div class="chat-container mt-4">                           
                            <img id="previewImage_{{ error.id }}" class="chat-image-preview border-4" style="display: none; width: 20%; height: 20%;">
                        </div>
                        <div class="border 1 mb-4">
                            <div class="chat-container mt-4 ml-2 mr-2 mb-4"> 
                                
                                <textarea id="chat_{{ error.id }}" onpaste="handlePaste(event, '{{ error.id }}')" class="form-control mb-1" style="height: auto; resize: none;" required></textarea>
                                
                                <input type="file" id="imageUpload_{{ error.id }}" class="d-none mt-2" accept="image/*" onchange="handleImageUpload(event, '{{ error.id }}')">
                                <input type="file" id="documentUpload_{{ error.id }}" class="d-none mt-2" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="handleDocumentUpload(event, '{{ error.id }}')">

                                
                                <button class="btn btn-primary" onclick="sendChat('{{ error.id }}')" style="height: 40px; width: 100px;" required>
                                    <i class="fa fa-send" style="font-size:18px;color:rgb(255, 255, 255)"></i> Send
                                </button>
                                
                                <label for="imageUpload_{{ error.id }}" class="btn btn-info ml-2 mr-2 mt-2 tooltip-button">
                                    <i class="fa fa-photo" style="font-size:18px;color:rgb(255, 255, 255)"></i>
                                    <span class="tooltip-text">Upload Image</span>
                                </label>
                                
                                <label for="documentUpload_{{ error.id }}" class="btn btn-warning  mt-2 tooltip-button">
                                    <i class="fa-solid fa-paperclip" style="font-size:18px;color:rgb(255, 255, 255)"></i>
                                    <span class="tooltip-text">Upload Document</span>
                                </label>
                            </div>
                            {% endif %}
                            <!-- Modal for full-size image -->
                            <div id="imageModal" class="modal">
                                <span class="close" onclick="closeModal()">&times;</span>
                                <img class="modal-content" id="modalImage">
                                <div id="caption"></div>
                                <p class="nav-button prev" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></p>
                                <p class="nav-button next" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></p>
                            </div>
                            

                             
                        </div>
                        
                    <!-- Modal for full-size image -->
                    </div>
                    {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                    {% if error.status != 'Finish' %}
                        <div class="chat-log ticket border p-4 mb-4 style="height: auto; resize: none;">
                            <form id="closeForm_{{error.id }}" method="post" action="/status_nv/{{ error.id }}/submit" class="mb-2">
                                
                                    <label for="reason_{{ error.id }}">Enter Solution Here:</label>
                                    
                                <div class="chat-container">        
                                    <textarea id="reason_{{ error.id }}" name="reason" class="form-control mb-2" required>{{ error.reason if error.reason is not none else "" }}</textarea>
                                    <button type="button" onclick="saveSolution({{ error.id }})" class="btn btn-primary mb-2 tooltip-button" style="height: 40px; width: 100px;">
                                        <i class="fa fa-save" style="font-size: 18px; color: rgb(255, 255, 255)"></i>
                                        <span class="tooltip-text">Save Solution</span>
                                    </button>
                                    
                                    <div class="col-auto">
                                    </div>
                                </div>
                            </form>
                        </div>
                    
                    </form>
                    {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                    <form action="/edit_er/{{ error.id }}" class="d-inline mr-2" > <!-- Example orderId is 1 --> 
                        <button type="submit" class="btn btn-warning tooltip-button"> <i class="fa-solid fa-pen" style="font-size:18px;color:rgb(255, 255, 255)"></i><span class="tooltip-text">Edit</span></button>
                    </form>
                    <button type="button" class="btn btn-danger tooltip-button mr-2" data-toggle="modal" data-target="#deleteModal" onclick="confirmDelete({{ error.id }}, '{{ error.error_number }}')">
                        <i class="fa fa-trash-can" style="font-size:18px;color:rgb(255, 255, 255)"></i><span class="tooltip-text">Delete</span>

                    </button>    
                    {% if 'adminbi' in current_user.roles or 'all' in current_user.roles %}
                    <form id="notify-creator-form" class="d-inline" action="{{ url_for('notify_creator', notification_type='error_detail', notification_id=error.id) }}" method="post">
                        <button type="submit" class="btn btn-primary">Notify to Creator</button>
                    </form>
                    {%endif%}
                    
                    {% if error.reason and ('' in error.reason or '' in error.reason) %}           
                    <form action="/close_nv/{{ error.id }}" method="post" class="d-inline" id="closeForm">
                        <button type="button" class="btn btn-success tooltip-button" data-toggle="modal" data-target="#closeModal" onclick="confirmClose('{{ error.id }}')">
                            <i class="fa fa-check" style="font-size:18px;color:rgb(255, 255, 255)"></i> <span class="tooltip-text">Finish</span>
                        </button>
                    </form>
                    {%endif%}
                    {%endif%}
                    {%endif%}
                    
               
                </div>
             {% endif %}
             <p class="small text-muted mt-2"> BI - Navision - Helpdesk Center - TEST VERSION001 Ref.07</p>
        </div>
    </div>

<!-- Modal สำหรับการปิดตั๋ว -->


<!-- Include SweetAlert2 library -->


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function showSuccessModal() {
            $('#successModal').modal('show');
        }
    </script>
    <script>
        function handleDocumentUpload(event, errorId) {
    const file = event.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('document', file);
        formData.append('error_id', errorId);

        fetch('/upload_document', {  // Adjust this URL as necessary
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Document uploaded successfully:', data);
                // Optionally, refresh the chat or update the UI
            } else {
                alert('Upload failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed');
        });
    } else {
        alert('Please select a document to upload');
    }
}


    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            // Handle form submission
            $('#notify-creator-form').on('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission
    
                $.ajax({
                    url: $(this).attr('action'), // Form action URL
                    method: 'POST',
                    data: $(this).serialize(), // Serialize form data
                    success: function(response) {
                        // Check if the response indicates success
                        if (response.status === 'success') {
                            Swal.fire({
                                title: 'Success!',
                                text: 'Notification sent to the creator.',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: response.message || 'Failed to send notification.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to send notification.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
        });
    </script>
    <script>


    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script type="text/javascript">
         var protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
         var socket = io.connect(protocol + '//' + document.domain + ':' + location.port);
    
        socket.on('connect', function() {
            console.log('Connected to server');
        });
    
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });
        socket.on('error_deleted', function(data) {     
                    // ดึงหมายเลขของตั๋วที่ถูกลบ
            console.log('error_deleted:', data);
        });
        socket.on('update_chat_log', function(data) {
            var errorId = data.error_id;
            var updatedChatLog = data.updatedChatLog;
    
            // Update chat log section for the specific ticket
            var chatLogDiv = document.getElementById('chat_log_' + errorId);
            if (chatLogDiv) {
                chatLogDiv.innerHTML = updatedChatLog;
            }
        });
        // Receive chat messages from the server
// Receive chat messages from the server
socket.on('receive_chat_nv', function(data) {
    // Ensure chatBox is defined before accessing it
    const chatBox = document.getElementById(`chat_box_${data.error_id}`);
    if (chatBox) {
        const newMessage = document.createElement('p');
        newMessage.id = `message_${data.id}`;
        newMessage.className = 'white-bg mt-1 mb-1 message-container zoom';
        
        newMessage.innerHTML = `
            <img src="${data.image_user}" alt="User Image" class="user-image-thumbnail" />
            <strong>${data.sender}:</strong>
            ${data.message}
            ${data.image_path ? `<img id="myImg" src="${data.image_path}" class="chat-image-thumbnail image-container" onclick="viewFullImage('${data.image_path}')" />` : ''}
            ${data.document_path ? `<a href="${data.document_path}" target="_blank">Download Document</a>` : ''}
            <small>(${data.timestamp})</small>
        `;

        if (data.image_path) {
            const deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-image-link';
            deleteLink.dataset.imageId = data.id;
            deleteLink.onclick = function(event) {
                deleteImage(event, data.image_path);
            };
            deleteLink.textContent = 'Delete';
            newMessage.appendChild(deleteLink);
        }

        chatBox.appendChild(newMessage);
    }
    window.location.reload();
});


// Function to send chat message
function sendChat(errorId) {
    const messageInput = document.getElementById(`chat_${errorId}`);
    const message = messageInput.value.trim();
    const imageInput = document.getElementById(`imageUpload_${errorId}`);
    const imageFile = imageInput.files[0];
    const formData = new FormData();
    const username = "{{ current_user.displayname }}";

    formData.append("error_id", errorId);
    formData.append("message", message);
    formData.append("sender", username);

    if (imageFile) {
        formData.append("image", imageFile);
    }

    if (message || imageFile) {
        fetch("/send_chat_nv", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Bad request');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                imageInput.value = '';
                document.getElementById(`previewImage_${errorId}`).style.display = 'none';
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while sending the message.");
        });
    } else {
        alert("Please enter a message or upload an image.");
    }
}

        document.addEventListener("DOMContentLoaded", function() {
            // เลือกตัวแปร ticketStatus จากข้อมูลที่รับมาจากแบ็คเอนด์
            var ticketStatus = "{{ error.status }}";

            // ตรวจสอบสถานะของ ticket เพื่อปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ ตามเงื่อนไข
            if (ticketStatus === 'Finish') {
                // หาก ticket มีสถานะเป็น 'Finish' ให้ปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ
                var buttons = document.querySelectorAll(".btn:not(.banner .btn)");
                buttons.forEach(function(button) {
                    button.disabled = true; // ปิดการใช้งานปุ่ม
                });
                var textAreas = document.querySelectorAll("textarea");
                textAreas.forEach(function(textArea) {
                    textArea.disabled = true; // ปิดการใช้งาน textarea
                    textArea.style.pointerEvents = "none"; // ไม่ให้รับอีเวนต์การคลิก
                });
                // แสดง Popup ว่าไม่สามารถแก้ไข ticket ที่เสร็จแล้วได้
                
            } else {
                // ถ้า ticket ยังเปิดให้ทำการเปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ
                var editableButtons = document.querySelectorAll(".editable");
                editableButtons.forEach(function(button) {
                    button.disabled = false;
                     // เปิดการใช้งานปุ่ม
                });
            }
        });
        
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var errorId = '{{error.id }}';
            var reasonElement = document.getElementById("reason_" + errorId);
            if (reasonElement) {
                var reasonValue = reasonElement.value;
                console.log("Reason Value:", reasonValue);
            } else {
                console.log("Reason element not found");
            }
        });


        $(document).ready(function() {
            function showLoading() {
            $('#loading').show();

            // Set a timeout to hide the loading spinner after 2 seconds
            return setTimeout(function() {
                $('#loading').hide();
            }, 2000);
        }


    function hideLoading() {
        $('#loading').hide();
    }

    // Show loading screen on link click
    $('a').on('click', function(e) {
        if (!$(this).hasClass('no-loading')) {
            showLoading();
        }
    });

    // Show loading screen on form submit
    $('form').on('submit', function() {
        showLoading();
    });

    // Hide loading screen on page load
    $(window).on('load', function() {
        hideLoading();
    });

    // You can also manually show the loading screen if needed
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
});


    </script>
 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'th,en'
            }, 'google_translate_element');
        }

    </script>
    
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
function submitForm(form) {
    var formData = new FormData(form);

    $.ajax({
        url: form.action,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                socket.emit('status_updated', { status: response.new_status }); // Emit new status
                window.location.reload(); // Refresh the page
            } else {
                socket.emit('status_updated', { status: response.new_status }); // Emit new status
                window.location.reload(); // Refresh the page
            }
        },
        error: function(xhr) {
            var errorMessage = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Unknown error';
            console.error('Error:', errorMessage);
        }
    });
}



socket.on('new_status', function(data) {
    var statusLabel = document.querySelector('label[for="status-select"]');
    var dropdownContainer = document.querySelector('.styled-dropdown');

    // Clear existing content in dropdownContainer
    dropdownContainer.innerHTML = '';

    // Update status label color based on new status
    statusLabel.classList.remove('red-text', 'yellow-text', 'green-text');
    if (data.status === 'Finish') {
        statusLabel.classList.add('green-text');
    } else if (data.status === 'In Progress') {
        statusLabel.classList.add('yellow-text');
    } else {
        statusLabel.classList.add('red-text'); // Default case
    }

    // Update status label text
    statusLabel.innerHTML = `<strong>Status : </strong>${data.status}`;

    // Add action forms based on the new status
    if (data.userRole === 'adminbi' || data.userRole === 'all') {
        if (!['Finish', 'In Progress', 'Wait for Requester', 'Wait for Admin'].includes(data.status)) {
            dropdownContainer.innerHTML += `
                <form id="status-form" action="/update_status_error/${data.error_id}" method="POST">
                    <input type="hidden" name="status" value="In Progress">
                    <a href="#" class="small Link ml-4" onclick="submitForm(this.closest('form'))">Change to In Progress</a>
                </form>`;
        }
        if (['In Progress', 'Wait for Admin'].includes(data.status)) {
            dropdownContainer.innerHTML += `
                <form action="/update_status_error/${data.error_id}" method="POST" class="ml-4">
                    <input type="hidden" name="nowerror_status" value="Wait for Requester">
                    <a href="#" class="small Link" onclick="submitForm(this.closest('form'))">Send to Requester</a>
                </form>`;
        }
    } else if (data.userRole === 'user') {
        if (data.status === 'Wait for Requester') {
            dropdownContainer.innerHTML += `
                <form action="/update_status_error/${data.error_id}" method="POST" class="ml-4">
                    <input type="hidden" name="nowerror_status" value="Wait for Admin">
                    <a href="#" class="small Link" onclick="submitForm(this.closest('form'))">Send to Admin</a>
                </form>`;
        }
    }

    // Add the new chat message with timestamp
    var newMessageHtml = `
        <p class="white-bg mt-1 mb-1 message-container zoom">
            <strong>System:</strong> Change status to ${data.status} on ${data.timestamp}
            <small>(${data.timestamp})</small>
        </p>
    `;
    $('.chat').append(newMessageHtml);
    window.location.reload();
});


        function handleImageUpload(event, errorId) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {


                    showSuccessModal();
                    
                };
                reader.readAsDataURL(file);
            }
        }

        function resizeImage(base64Str, maxWidth, maxHeight, callback) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round(width * (maxHeight / height));
                        height = maxHeight;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const resizedDataUrl = canvas.toDataURL('image/jpeg');
                callback(resizedDataUrl);
            };
            img.src = base64Str;
        }

        function handleKeyDown(event, errorId) {
    if (event.key === 'Enter' && !event.shiftKey) { // ตรวจสอบว่ากดปุ่ม Enter และไม่กด Shift
        event.preventDefault(); // ป้องกันการเพิ่มบรรทัดใหม่ใน textarea
        sendChat(errorId); // เรียกฟังก์ชันส่งข้อความ
    }
}

// เพิ่ม event listener ใน JavaScript
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('keydown', (event) => {
            const errorId = textarea.id.split('_')[1]; // ดึง errorId จาก id ของ textarea
            handleKeyDown(event, errorId);
        });
    });
});

        document.addEventListener('paste', function(event) {
            const clipboardItems = event.clipboardData.items;
            for (const item of clipboardItems) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resizeImage(e.target.result, 800, 800, function(resizedImage) {
                            // Append the image to the chat input
                            const chatInput = document.querySelector('textarea.form-control');
                            chatInput.value += `<img src="${resizedImage}" class="chat-image-thumbnail" onclick="viewFullImage('${resizedImage}')"/>`;
                        });
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        function updateChatLog(errorId) {
            fetch(`/chat_nv/${errorId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                        const chatLogElement = document.getElementById(`chat_log_${errorId}`);
                        if (chatLogElement) {
                            chatLogElement.innerHTML = data.updatedChatLog;
                        } else {
                            console.error(`Element chat_log_${errorId} not found`);
                        }
                    } else {
                        console.error('Failed to update chat log');
                    }
                })
                .catch(error => {
                    console.error('Error updating chat log:', error);
                });
        }
function deleteMessage(messageId) {
    Swal.fire({
        title: 'Are you sure?',
        text: 'Are you sure you want to delete this message?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/delete_message_nv/${messageId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    document.getElementById(`message_${messageId}`).remove();
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Message deleted successfully'
                    }).then(() => {
                        window.location.reload(); // Reload the page after deleting
                    });
                } else {
                    response.json().then(data => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Failed to delete message: ' + data.error
                        });
                    });
                }
            }).catch(error => {
                console.error("Error deleting message:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while deleting the message.'
                });
            });
        }
    });
}
function saveSolution(errorId) {
    var reasonInput = document.getElementById("reason_" + errorId);
    var reason = reasonInput.value.trim();

    // Validate reason input
    if (reason === '') {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please enter a solution before saving.'
        });
        return;
    }

    // Submit the form via AJAX
    var formData = new FormData();
    formData.append("reason", reason);

    fetch(`/status_nv/${errorId}/submit`, {
        method: "POST",
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Show success message
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Solution saved successfully.',
            timer: 1500,
            timerProgressBar: true
        }).then(() => {
            // Optionally reload the page or handle further actions
            window.location.reload();
        });
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'An error occurred while saving the solution.'
        });
    });
}

function deleteImage(event, imagePath) {
    event.preventDefault(); // ป้องกันการโหลดหน้าใหม่

    Swal.fire({
        title: 'Are you sure?',
        text: 'Are you sure you want to delete this image?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            // ส่งคำขอลบไฟล์ภาพไปยังเซิร์ฟเวอร์
            fetch('/delete_image_nv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image_path: imagePath })
            })
            .then(response => {
                if (response.ok) {
                    // ลบรูปภาพจาก DOM หลังจากลบสำเร็จ
                    var imageElement = event.target.previousElementSibling;
                    imageElement.parentNode.removeChild(imageElement);
                    event.target.parentNode.removeChild(event.target);
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Image deleted successfully'
                    }).then(() => {
                        window.location.reload(); // Reload the page after deleting
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Failed to delete image'
                    });
                }
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while deleting the image'
                });
            });
        }
    });
}

function updateErrorOrder(errorId, field, value) {
    const data = {
        field: field,
        value: value
    };

    fetch(`/update_error/${errorId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Update successful'
            }).then(() => {
                window.location.reload(); // Reload the page after successful update
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'Failed to update'
            });
        }
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'An error occurred while updating'
        });
    });
}
function updateResponsible(errorId, field, value) {
    const data = {
        field: field,
        value: value
    };

    fetch(`/update_error/${errorId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Update successful'
            }).then(() => {
                window.location.reload(); // Reload the page after successful update
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'Failed to update'
            });
        }
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'An error occurred while updating'
        });
    });
}

</script>
<script>
    $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip(); 
    });
</script>
<script>
    // Polyfill for crypto.randomUUID
    if (!crypto.randomUUID) {
        crypto.randomUUID = function() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 0x0f) >> 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        };
    }

    function handlePaste(event, errorId) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageData = event.target.result;
                    uploadImageFromData(imageData, errorId);
                };
                reader.readAsDataURL(file);
            }
        }
    }

    function handleImageUpload(event, errorId) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const imageData = event.target.result;
            
            uploadImageFromData(imageData, errorId);
        };
        reader.readAsDataURL(file);
    }

    function uploadImageFromData(imageData, errorId) {
        fetch('/upload_image_nv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ imageData: imageData, errorId: errorId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
                displayImageInChat(data.imageUrl, errorId);
            } else {
                console.error('Failed to upload image:', data.error);
            }
        })
        .catch(error => {
            console.error('Error uploading image:', error);
        });
    }

    function displayImageInChat(imageUrl, errorId) {
        const chatDiv = document.querySelector('.chat');
        const p = document.createElement('p');
        p.classList.add('white-bg', 'mt-1', 'mb-1', 'message-container');

        const img = document.createElement('img');
        img.src = imageUrl;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => viewFullImage(imageUrl);

        p.appendChild(img);
        chatDiv.appendChild(p);
    }
    var currentImageIndex = 0;
var images = []; // เก็บรายชื่อภาพ

function viewFullImage(src) {
    var modal = document.getElementById("imageModal");
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");

    // เพิ่มภาพใน array และตั้งค่า index
    images = []; // ล้าง array ก่อน
    document.querySelectorAll('.chat-image-thumbnail').forEach(img => {
        images.push(img.src);
    });

    currentImageIndex = images.indexOf(src);

    modal.style.display = "flex"; // ใช้ flexbox เพื่อให้ modal อยู่กลางจอ
    modalImg.src = src;
    captionText.innerHTML = ""; // ใส่คำบรรยายถ้าต้องการ
}
// Close the modal
function closeModal() {
    document.getElementById("imageModal").style.display = "none";
}
window.onclick = function(event) {
    var modal = document.getElementById("imageModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// Change image when clicking on navigation buttons
function changeImage(n) {
    currentImageIndex += n;
    if (currentImageIndex >= images.length) currentImageIndex = 0;
    if (currentImageIndex < 0) currentImageIndex = images.length - 1;
    
    var newImageSrc = images[currentImageIndex];
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");
    
    modalImg.src = newImageSrc;
    captionText.innerHTML = "Image " + (currentImageIndex + 1) + " of " + images.length;
}


    function edit(event, orderId) {
        event.preventDefault(); // Prevent form submission
        alert("Coming soon. This function is not available now.");
        window.location.reload();
    }
</script>
<script>
    function confirmDelete(errorId,errorNumber) {
        Swal.fire({
            title: 'Delete Confirmation',
            html: `Are you sure you want to delete Error No.  <br> ${errorNumber}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Delete'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/delete_error/${errorId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Error has been deleted.',
                            icon: 'success'
                        }).then(() => {
                            window.location.href = '/my_tasks'; // Redirect to all_tickets page
                        });
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to delete error: ' + data.message,
                            icon: 'error'
                        });
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to delete error.',
                        icon: 'error'
                    });
                });
            }
        });
    }
</script>
<script>
function confirmClose(errorId) {
    Swal.fire({
        title: 'Close Confirmation',
        text: `Are you sure you want to close Error No. ${errorId}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Close'
    }).then((result) => {
        if (result.isConfirmed) {
            const reason = document.getElementById("reason_" + errorId).value.trim();

            // Check if reason is provided
            if (reason === '') {
                Swal.fire('Error!', 'Please provide a reason before closing the Error.', 'error');
                return;
            }

            // Submit form to server
            fetch(`/close_nv/${errorId}`, {
                method: 'POST',
                body: JSON.stringify({ reason: reason }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Closed!',
                        text: 'Error has been closed.',
                        icon: 'success'
                    }).then(() => {
                        window.location.reload(); // Reload the page after closing
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to close error: ' + data.message,
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while closing the ticket.',
                    icon: 'error'
                });
            });
        }
    });
}

</script>

</body>
</html>

