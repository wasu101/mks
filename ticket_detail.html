<!DOCTYPE html>
<html lang="en">
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=2.0">
    <title>Ticket Detail {{ ticket.ticket_number }} </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="{{ url_for('static', filename='images/logo1.ico') }}" type="image/x-icon">
    <link href="{{ url_for('static', filename='fontawesomefree/css/fontawesome.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='fontawesomefree/css/brands.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='fontawesomefree/css/solid.css') }}" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <!-- Custom CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>
    /* General Styles */
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 0;
    }
    .user-image-thumbnail {
    width: 40px; /* Set width */
    height: 40px; /* Set height */
    border-radius: 50%; /* Optional: Make it round */
    object-fit: cover; /* Maintain aspect ratio and cover the area */
}

    .container {
        background-color: #ffffff;
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Zoom Effect */
    .zoom {
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        transition: transform 0.3s ease-in-out;
        width: 100%;
        height: 100%;
        margin: 0 auto;
        border-radius: 8px;
    }
    
    .zoom:hover {
        transform: scale(1.05);
    }
    
    /* Styled Dropdown */
    .styled-dropdown {
        margin-bottom: 15px;
    }
    
    .styled-dropdown select {
        width: 100%;
        font-size: 16px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        color: #333;
    }
    
    /* Alerts */
    .alert-container {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 300px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        pointer-events: none;
    }
    
    .alert {
        width: 100%;
        padding: 15px;
        margin-top: 10px;
        background-color: #fff;
        color: #333;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: opacity 0.3s ease;
        opacity: 1;
    }
    
    .alert.success {
        background-color: #4caf50;
        color: #fff;
    }
    
    .alert.info {
        background-color: #2196f3;
        color: #fff;
    }
    
    .alert.warning {
        background-color: #ff9800;
        color: #fff;
    }
    
    /* Close Button */
    .closebtn {
        margin-left: 15px;
        color: white;
        font-weight: bold;
        float: right;
        font-size: 22px;
        cursor: pointer;
        transition: color 0.3s;
    }
    
    .closebtn:hover {
        color: #000;
    }
    
    /* Navigation */
    nav {
        background-color: #333;
        padding: 10px 0;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    nav ul {
        list-style-type: none;
        padding: 0;
    }
    
    nav ul li {
        display: inline;
        margin-right: 20px;
    }
    
    nav ul li a {
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        transition: color 0.3s ease;
    }
    
    nav ul li a:hover {
        color: #f0f0f0;
    }
    
    /* Footer */
    footer {
        text-align: center;
        padding: 20px;
        background-color: #333;
        color: #fff;
    }
    
    /* Form Controls */
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }
    
    /* Buttons */
    .btn-primary {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    /* Chat and Messages */
    .chat {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .delete-message {
        color: red;
        cursor: pointer;
    }
    
    .chat-image-thumbnail {
        max-width: 200px;
        margin-top: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Modal Container */
    .modal {
        display: none; /* ซ่อน modal เริ่มต้น */
        position: fixed; /* ใช้ position fixed เพื่อให้ modal อยู่กลางจอ */
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0); /* สีพื้นหลังของ modal */
        background-color: rgba(0,0,0,0.8); /* ให้พื้นหลังโปร่งแสง */
    }
    
    /* Modal Content (Image) */
    .modal-content {
        display: block;
        margin: auto;
        max-width: 90%;
        max-height: 80vh; /* จำกัดความสูงเพื่อไม่ให้เกินความสูงของ viewport */
        object-fit: contain; /* ทำให้รูปภาพแสดงอย่างสมส่วน */
        transition: transform 0.25s ease; /* การเปลี่ยนแปลงของ scale */
    }
    .close {
    position: absolute;
    top: 20px; /* Position from the top */
    right: 20px; /* Position from the right */
    color: white; /* Close button color */
    font-size: 30px; /* Close button size */
    font-weight: bold; /* Close button weight */
    cursor: pointer; /* Pointer on hover */
    z-index: 1001; /* Ensure it is on top of the image */
}
    /* Zoom Controls */
    .zoom-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }
    
    .zoom-button {
        padding: 10px;
        font-size: 20px;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        border: none;
        cursor: pointer;
        border-radius: 3px;
    }
    
    .zoom-button:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }
    

    .nav-button {
    position: absolute;
    top: 50%; /* Center vertically */
    transform: translateY(-50%); /* Adjust for vertical centering */
    color: white; /* Button color */
    font-size: 30px; /* Button size */
    font-weight: bold; /* Button weight */
    cursor: pointer; /* Pointer on hover */
    background-color: rgba(255, 255, 255, 0.3); /* Semi-transparent background */
    width: 50px; /* Fixed width for perfect circular shape */
    height: 50px; /* Fixed height for perfect circular shape */
    border-radius: 50%; /* Make buttons circular */
    display: flex; /* Use flexbox to center content */
    align-items: center; /* Center vertically */
    justify-content: center; /* Center horizontally */
    transition: background-color 0.2s; /* Smooth background change */
}

.prev {
    left: 20px; /* Position to the left */
}

.next {
    right: 20px; /* Position to the right */
}

.prev:hover, .next:hover {
    background-color: rgba(255, 255, 255, 0.5); /* Change background on hover */
}

    /* Loading Spinner */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #007bff;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Tooltips */
    .tooltip-button {
        position: relative;
        display: inline-block;
    }
    
    .tooltip-text {
        visibility: hidden;
        width: 120px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 5px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .tooltip-button:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        width: 300px;
    }
    
    .toast {
        position: relative;
        background-color: #333;
        color: #fff;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .toast.show {
        opacity: 1;
    }
    
    .toast-progress {
        height: 4px;
        background-color: #007bff;
        width: 0%;
        position: absolute;
        bottom: 0;
        left: 0;
        border-radius: 0 0 5px 5px;
    }
    /* สไตล์ของภาพที่แสดงในแชท */
    .chat-image-thumbnail {
        max-width: 200px; /* ขนาดกว้างสุดของภาพ */
        max-height: 200px; /* ขนาดสูงสุดของภาพ */
        border: 2px solid #000000; /* ขอบของภาพ */
        border-radius: 10px; /* มุมของขอบภาพ */
        object-fit: cover; /* ทำให้ภาพครอบคลุมพื้นที่ได้อย่างดี */
        cursor: pointer; /* เปลี่ยนเคอร์เซอร์เมื่อชี้ที่ภาพ */
        transition: transform 0.2s ease, box-shadow 0.2s ease; /* การเปลี่ยนแปลงเมื่อมีการโฮเวอร์ */
    }
    
    .chat-image-thumbnail:hover {
        transform: scale(1.05); /* ขยายภาพเมื่อโฮเวอร์ */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* เงาให้ภาพเด่นขึ้น */
    }
    
    /* สไตล์ของ container ของภาพ */
    .image-container {
        display: inline-block;
        position: relative;
        margin: 5px; /* การเว้นระยะห่างรอบ ๆ ภาพ */
    }
    
    .image-container:hover .delete-image-link {
        display: block; /* แสดงปุ่มลบเมื่อชี้ที่ container */
    }
    
    .delete-image-link {
        display: none; /* ซ่อนปุ่มลบเริ่มต้น */
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 255, 255, 0.7); /* สีพื้นหลังของปุ่มลบ */
        padding: 5px;
        border-radius: 3px;
        color: #ff0000;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
    }
    
        </style>
</head>
<body>
    <header>

        <div class="banner justify-content-end">
            <h1 class="mb-4 mt-4 ml-0 mr-4 text-center">Ticket Details</h1>
            <div class="controlbt d-flex justify-content-end">
                <form action="/my_tasks" method="get" class="d-inline mr-2">
                    <button id="print-button" type="submit" class="btn btn-link tooltip-button"><i class="fa-solid fa-arrow-left" style="font-size:28px;color:rgb(0, 0, 0)"></i><span class="tooltip-text">Back</span></button>
                    <button id="print-button" class="btn btn-link tooltip-button " onclick="window.print()"><i class="fa fa-print" style="font-size:28px;color:rgb(0, 0, 0)"></i><span class="tooltip-text">Print This Ticket</span></button>
                    <div id="google_translate_element" class="btn btn-link"></div>
                </form>
            </div>
        </div> 

    </header>        
    <div class="container">
            <!-- ส่วนของ Tickets (ซ้าย) -->

                <!-- Iterate through tickets -->
                <div class="ticket border p-8 mb-4">
                    <h2 class="text-primary" style="background-color: #c3e4ff; text-align: center; height: 55px;"><strong>Ticket No:</strong> {{ ticket.ticket_number }}</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Ticket details -->
                            <h5 class="text-primary"><strong>Name Requester:</strong> {{ ticket.title }}</h5>
                            
                            <div class="dropdown mt-1">
                                <div class="styled-dropdown" style="display: flex;">
                                    <label for="status-select" class="{% if ticket.status == 'open' %}red-text{% elif ticket.status == 'in_progress' %}yellow-text{% else %}green-text{% endif %}"><strong>Status:</strong> {{ ticket.status }}</label>
                                    {% if 'adminit' in current_user.roles or 'all' in current_user.roles %}
                                        {% if ticket.status not in ['Finish', 'in_progress'] %}
                                            <form id="status-form" action="{{ url_for('update_ticket_status', ticket_id=ticket.id) }}" method="POST">
                                                <a href="#" class="small Link ml-4" onclick="submitForm()">Change to In Progress</a>
                                                <input type="hidden" name="status" value="in_progress">
                                            </form>
                                        {% endif %}

                                    {% endif %}
                                </div>
                            </div>
                        
                            {% if ticket.status in ['open', 'in_progress'] %}
                                <div class="dropdown mt-1">
                                    <div class="styled-dropdown" style="display: flex;">
                                        <label for="urgencyType_{{ ticket.id }}"><strong>Priority:</strong></label>
                                        <select class="ml-4" style="width: 200px; height: 40px;" id="urgencyType_{{ ticket.id }}" name="urgencyType" 
                                            {% if not ('adminit' in current_user.roles or 'all' in current_user.roles) %} disabled {% endif %} 
                                            onchange="setUrgency({{ ticket.id }}, this.value)">
                                            <option value="" {% if ticket.type == '' %} selected {% endif %}>--select type--</option>
                                            <option value="low" {% if ticket.type == 'low' %} selected {% endif %}>low</option>
                                            <option value="middle" {% if ticket.type == 'middle' %} selected {% endif %}>middle</option>
                                            <option value="high" {% if ticket.type == 'high' %} selected {% endif %}>high</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <div class="styled-dropdown" style="display: flex;">
                                        <label for="issue_type_{{ ticket.id }}"><strong>Issue Type:</strong></label>
                                        <select id="issue_type_{{ ticket.id }}" style="width: 200px; height: 40px;" 
                                            {% if not ('adminit' in current_user.roles or 'all' in current_user.roles) %} disabled {% endif %} 
                                            onchange="handleIssueSelection('{{ ticket.id }}', this.value)">
                                            <option value="None"{% if ticket.issuetype == 'None' %} selected {% endif %}>--select issuetype--</option>
                                            <option value="OtherIssue"{% if ticket.issuetype == 'OtherIssue' %} selected {% endif %}>Other Issue</option>
                                            <option value="User"{% if ticket.issuetype == 'User' %} selected {% endif %}>User</option>
                                            <option value="Hardware"{% if ticket.issuetype == 'Hardware' %} selected {% endif %}>Hardware</option>
                                            <option value="Software"{% if ticket.issuetype == 'Software' %} selected {% endif %}>Software</option>
                                            <option value="Network"{% if ticket.issuetype == 'Network' %} selected {% endif %}>Network</option>
                                            <option value="FingerScan"{% if ticket.issuetype == 'FingerScan' %} selected {% endif %}>FingerScan</option>
                                            <option value="Printer"{% if ticket.issuetype == 'Printer' %} selected {% endif %}>Printer</option>
                                            <option value="Server"{% if ticket.issuetype == 'Server' %} selected {% endif %}>Server</option>
                                            <option value="CCTV"{% if ticket.issuetype == 'CCTV' %} selected {% endif %}>CCTV</option>
                                            <option value="IP Phone"{% if ticket.issuetype == 'IP Phone' %} selected {% endif %}>IP Phone</option>
                                            <option value="UPS"{% if ticket.issuetype == 'UPS' %} selected {% endif %}>UPS</option>
                                        </select>
                                    </div>
                                    <div id="subtypeDropdown_{{ ticket.id }}" class="styled-dropdown mt-2">
                                        <label for="subtype_{{ ticket.id }}"><strong>Subtype:</strong></label>
                                        <select id="subtype_{{ ticket.id }}" style="width: 200px; height: 40px;" 
                                            {% if not ('adminit' in current_user.roles or 'all' in current_user.roles) %} disabled {% endif %} 
                                            onchange="saveIssueType('{{ ticket.id }}', document.getElementById('issue_type_{{ ticket.id }}').value)">
                                            {% if ticket.subtype %}
                                                <option value="{{ ticket.subtype }}" selected>{{ ticket.subtype }}</option>
                                            {% else %}
                                                <option value="">--Select Subtype--</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                            {% else %}
                                <p><strong>Priority:</strong> {{ ticket.type }}</p>
                                <p><strong>Issue Type:</strong> {{ ticket.issuetype }} <strong>Subtype:</strong> {{ ticket.subtype }}</p>
                                <p><strong>Use time total:</strong> {{ ticket.total_time }}</p>
                            {% endif %} 
                        </div>
                        
                        <div class="col-md-6">
                            <p><strong>Department:</strong> {{ ticket.department }}</p>
                            <p><strong>Issue:</strong> {{ ticket.description }}</p>
                            <p><strong>Solution:</strong> {{ ticket.reason }}</p>
                            <p><strong>Created at:</strong> {{ ticket.created_at }}</p>
                            {% if ticket.status not in ['open', 'in_progress'] %}
                                <p><strong>Finished at:</strong> {{ ticket.close_at }}</p>
                            {% endif %}
                        </div>
                        
                    </div>
                    <div class="chat-log ticket border p-4">
                        <h4 class="small"><strong>Operation details for ticket No :</strong> {{ ticket.ticket_number }}</h4>
                        <div class="chat" id="chat_box_{{ ticket.id }}">
                            {% set messages_found = false %}
                            {% if chat_messages is not defined or chat_messages|length == 0 %}
                                <p class="small text-muted mt-2">No Chat History</p>
                            {% else %}
                                {% for message in chat_messages %}
                                    {% if message.ticket_id == ticket.id %}
    
                                        <p id="message_{{ message.id }}" class="white-bg mt-1 mb-1 message-container zoom">
                                            {% if message.image_user %}
                                                <img src="{{ message.image_user }}" class="chat-user-image" style="width: 40px; height: 40px; border-radius: 50%;" />
                                            {% endif %}
                                            <strong>{{ message.sender }}:</strong> {{ message.message }}
                                            {% if message.image_path %}
                                                <img style="border-color: #000000;" src="{{ url_for('static', filename='uploads/' + message.image_path.split('/')[-1]) }}" class="chat-image-thumbnail image-container border" onclick="viewFullImage('{{ url_for('static', filename='uploads/' + message.image_path.split('/')[-1]) }}')" />
                                                {% if ticket.status in ['Pending', 'in_progress'] %}
                                                    <a href="#" class="delete-image-link" data-image-id="{{ message.id }}" onclick="deleteImage(event, '{{ message.image }}')">Delete</a>
                                                {% endif %}
                                            {% endif %}
                                            <small>({{ message.timestamp }})</small>
                                            {% if ticket.status in ['Pending', 'in_progress'] %}
                                                <span class="delete-message small" onclick="deleteMessage('{{ message.id }}')">delete</span>
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    
                        {% if ticket.status != 'Finish' %}
                            <div class="chat-container mt-4">
                                <img id="previewImage_{{ ticket.id }}" class="chat-image-preview border-4" style="display: none; width: 20%; height: 20%;">
                                <div id="previewContainer_{{ ticket.id }}" class="image-preview-container" style="display: none;"></div>
                            </div>
                            <div class="border 1 mb-4">
                                <div class="chat-container mt-4 ml-2 mr-2 mb-4">
                                    <textarea id="chat_{{ ticket.id }}" onpaste="handlePaste(event, '{{ ticket.id }}')" class="form-control mb-1" style="height: auto; resize: none;" required placeholder="Type or job description here."></textarea>
                                    <input type="file" id="singleImageUpload_{{ ticket.id }}" class="d-none mt-2" accept="image/*" onchange="handleSingleImageUpload(event, '{{ ticket.id }}')">
                                    <input type="file" id="multipleImageUpload_{{ ticket.id }}" name="images" accept="image/*" multiple style="display: none;" onchange="handleMultipleImageUpload(event, '{{ ticket.id }}')">
                                    <button class="btn btn-primary" onclick="sendChat('{{ ticket.id }}')" style="height: 40px; width: 100px;" required>
                                        <i class="fa-solid fa-paper-plane" style="font-size:18px;color:rgb(255, 255, 255)"></i> Send
                                    </button>
                                    <div>
                                        <label for="multipleImageUpload_{{ ticket.id }}" class="btn btn-info ml-2 mr-2 mt-2 tooltip-button">
                                            <i class="fa-solid fa-image" style="font-size:18px;color:rgb(255, 255, 255)"></i>
                                            <span class="tooltip-text">Upload Images</span>
                                        </label>
                                    </div>
                                    <div id="previewContainer_{{ ticket.id }}"></div>
                                </div>
                            </div>
                            
                        {% endif %}
                        
                        <div id="uploadModal" class="modal">
                            <div class="modal-content">
                                <span class="close" onclick="closeUploadModal()">&times;</span>
                                <h2>Upload Images</h2>
                                <p>Your images are being uploaded. Please wait...</p>
                            </div>
                        </div>
                        
                        <div id="imageModal" class="modal">
                            <span class="close" onclick="closeModal()">&times;</span>
                            <img class="modal-content" id="modalImage">
                            <div id="caption"></div>
                            <!-- Previous and Next buttons -->
                            <p class="nav-button prev" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></p>
                            <p class="nav-button next" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></p>
                            
                        </div>
                        
                        
                    </div>
                    
                    {% if 'adminit' in current_user.roles or 'all' in current_user.roles %}
                    {% if ticket.status != 'Finish' %}
                        <div class="chat-log ticket border p-4 mb-4" style="height: auto; resize: none;">
                            <form id="closeForm_{{ ticket.id }}" method="post" action="/status/{{ ticket.id }}/submit" class="mb-2">

                                
                                    <label for="reason_{{ ticket.id }}">Enter Solution Here:</label>
                                    
                                <div class="chat-container">        
                                    <textarea id="reason_{{ ticket.id }}" name="reason" class="form-control mb-2" required onfocus="this.value=''">{{ ticket.reason if ticket.reason is not none else "" }} </textarea>
                                    <button type="button" class="btn btn-primary mb-2" style="height: 40px; width: 100px;" onclick="saveReason('{{ ticket.id }}')"><i class="fa-solid fa-save" style="font-size:18px;color:rgb(255, 255, 255)"></i> Save</button>

                                    
                                    <div class="col-auto">
                                    </div>
                                </div>
                            </form>
                        </div>
                    
                    </form>
                    <form action="/edit/{{ ticket.id }}"class="d-inline mr-2 " > <!-- Example orderId is 1 -->
                        <button type="submit" class="btn btn-warning tooltip-button"> <i class="fa fa-pencil-square" style="font-size:18px;color:rgb(255, 255, 255)"></i><span class="tooltip-text">Edit</span></button>
                    </form>
                    <button type="button" class="btn btn-danger mr-2 tooltip-button" data-toggle="modal" data-target="#deleteModal" onclick="openDeleteModal('{{ ticket.id }}')">
                        <i class="fa-solid fa-trash-can" style="font-size:18px;color:rgb(255, 255, 255)"></i><span class="tooltip-text">Delete</span>
                    </button>                  
                    {% if ticket.reason and ('' in ticket.reason or '' in ticket.reason) %}                
                    <form action="/close/{{ ticket.id }}" method="post" class="d-inline" id="closeForm">
                        <button type="button" class="btn btn-success tooltip-button" data-toggle="modal" data-target="#closeModal" onclick="closeTicket('{{ ticket.id }}')"><i class="fa-solid fa-check" style="font-size:18px;color:rgb(255, 255, 255)"></i>
                            <span class="tooltip-text">Finish</span>
                        </button>
                    </form>
                    {% endif %}
                    {% if 'admin' in current_user.roles or 'all' in current_user.roles %}
                    <form id="notify-creator-form" class="d-inline" action="{{ url_for('notify_creator', notification_type='ticket', notification_id=ticket.id) }}" method="post">
                        <button type="submit" class="btn btn-primary">Notify Ticket Creator</button>
                    </form>
                    {%endif%}
                    
             {% endif %}
             {% endif %}
             
    </div>
    <p class="small text-muted mt-2"> Rev.01 IT - MKS - TEST</p>

    <!-- Modal สำหรับแจ้งผลการบันทึกข้อมูล -->
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="successModalBody">
                    Data update successful.
                </div>
            </div>
        </div>
    </div>
    <div id="loading" style="display:none;">
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <p></p>
        </div>
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        $('#notify-creator-form').on('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            $.ajax({
                url: $(this).attr('action'), // Form action URL
                method: 'POST',
                data: $(this).serialize(), // Serialize form data
                success: function(response) {
                    // Check if the response indicates success
                    if (response.status === 'success') {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Notification sent to the creator.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'Failed to send notification.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to send notification.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#notification-icon').on('click', function(event) {
            event.preventDefault();  // Prevent default link behavior

            var type = $(this).data('type');  // Get the type from data attribute
            var id = $(this).data('id');      // Get the ID from data attribute

            var url = '/notify/' + type + '/' + id;  // Construct URL based on type and ID

            // Send AJAX request
            $.ajax({
                url: url,
                type: 'POST',
                success: function(response) {
                    // Handle success
                    alert('Notification sent successfully!');
                },
                error: function(xhr, status, error) {
                    // Handle error
                    alert('Failed to send notification.');
                }
            });
        });
    });
</script>


    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'th,en'
            }, 'google_translate_element');
        }
    
        function showLoading() {
            $('#loading').show();

            // Set a timeout to hide the loading spinner after 2 seconds
            return setTimeout(function() {
                $('#loading').hide();
            }, 2000);
        }

    function hideLoading() {
        $('#loading').hide();
    }

    // Show loading screen on link click
    $('a').on('click', function(e) {
        if (!$(this).hasClass('no-loading')) {
            showLoading();
        }
    });

    // Show loading screen on form submit
    $('form').on('submit', function() {
        showLoading();
    });

    // Hide loading screen on page load
    $(window).on('load', function() {
        hideLoading();
    });

    // You can also manually show the loading screen if needed
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;


    </script>
    
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
       
    <script>
        function handleKeyDown(event, ticketId) {
    if (event.key === 'Enter' && !event.shiftKey) { // ตรวจสอบว่ากดปุ่ม Enter และไม่กด Shift
        event.preventDefault(); // ป้องกันการเพิ่มบรรทัดใหม่ใน textarea
        sendChat(ticketId); // เรียกฟังก์ชันส่งข้อความ
    }
}

// เพิ่ม event listener ใน JavaScript
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('keydown', (event) => {
            const ticketId = textarea.id.split('_')[1]; // ดึง errorId จาก id ของ textarea
            handleKeyDown(event, ticketId);
        });
    });
});
        $(document).ready(function() {
            function showSuccessModal() {
                $('#successModal').modal('show');
            }
            
            function viewFullImage(imageSrc) {
                var fullImage = document.getElementById('fullImage');
                fullImage.src = imageSrc;
                $('#imagePreviewModal').modal('show'); // เปิด modal เมื่อรูปภาพเต็มขนาดพร้อมแสดง
            }
        
            function closeFullImage() {
                $('#imagePreviewModal').modal('hide'); // ปิด modal เมื่อรูปภาพเต็มขนาดถูกปิด
            }
        
            function confirmClose(ticketId) {
                // แสดง SweetAlert ยืนยันการปิด Ticket
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you want to close this ticket?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, close it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // ส่งคำร้องขอไปยังเซิร์ฟเวอร์
                        $('#closeForm').attr('action', '/close/' + ticketId);
                        $('#closeForm').submit(); // ส่งคำร้องขอ
                    }
                });
            }
  
        
            function handleImageUpload(event, ticketId) {
                $('#imagePreviewModal').modal('show'); // เปิด modal
            };
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            let ticketIdToDelete;
    
            window.openDeleteModal = function(ticketId) {
                ticketIdToDelete = ticketId;
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'You will not be able to recover this ticket!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        confirmDelete(ticketIdToDelete);
                    }else{
                        Swal.fire("Cancelled", "Your ticket is safe :)", "error");
                    }
                });
            };
    
            window.confirmDelete = function(ticketId) {
                fetch(`/delete_tk/${ticketIdToDelete}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Your ticket has been deleted.',
                            icon: 'success',
                            timer: 2000,
                            timerProgressBar: true
                        }).then(() => {
                            window.location.href = '/my_tasks'; // Redirect to all_tickets page
                        });
                    } else {
                        Swal.fire({
                            title: 'Failed to delete!',
                            text: 'Failed to delete Ticket: ' + data.message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to delete Ticket',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            };
        });
    </script>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script type="text/javascript">
        var protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
        var socket = io.connect(protocol + '//' + document.domain + ':' + location.port);
    
        socket.on('connect', function() {
            console.log('Connected to server');
        });
    
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });
    
        socket.on('update_chat_log', function(data) {
            var ticketId = data.ticket_id;
            var updatedChatLog = data.updatedChatLog;
    
            // Update chat log section for the specific ticket
            var chatLogDiv = document.getElementById('chat_log_' + ticketId);
            if (chatLogDiv) {
                chatLogDiv.innerHTML = updatedChatLog;
            }
        });
        socket.on('ticket_deleted', function(data) {
            // ดึงหมายเลขของตั๋วที่ถูกลบ
            location.reload();
            console.log('Ticket deleted:', data);
        });
        socket.on('ticket_update', function(data) {
    // Show a notification to the creator
    showNotification("Ticket Updated", `Ticket No: ${data.id} has been updated. Check the details.`);

    // Optionally, update the UI with the new ticket details
    // Example:
    var updatedTicketHtml = `
        <p>Title: ${data.title}</p>
        <p>Description: ${data.description}</p>
        <p>Department: ${data.department}</p>
        <p>Updated At: ${data.updated_at}</p>
    `;

    document.querySelector('#ticket_details').innerHTML = updatedTicketHtml;
});
// Function to show a notification
function showNotification(title, body) {
    if ("Notification" in window) {
        Notification.requestPermission().then(function(permission) {
            if (permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: "/static/favicon.ico"  // Path to the icon
                });
            }
        });
    }
}

// Listen for ticket update notifications
socket.on('ticket_update_notification', function(data) {
    const title = `Update for Ticket No: ${data.ticket_id}`;
    const body = data.update_info;

    // Show the notification
    showNotification(title, body);
});

        document.addEventListener("DOMContentLoaded", function() {
            // เลือกตัวแปร ticketStatus จากข้อมูลที่รับมาจากแบ็คเอนด์
            var ticketStatus = "{{ ticket.status }}";

            // ตรวจสอบสถานะของ ticket เพื่อปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ ตามเงื่อนไข
            if (ticketStatus === 'Finish') {
                // หาก ticket มีสถานะเป็น 'Finish' ให้ปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ
                var buttons = document.querySelectorAll(".btn:not(.banner .btn)");
                buttons.forEach(function(button) {
                    button.disabled = true; // ปิดการใช้งานปุ่ม
                });
                var textAreas = document.querySelectorAll("textarea");
                textAreas.forEach(function(textArea) {
                    textArea.disabled = true; // ปิดการใช้งาน textarea
                    textArea.style.pointerEvents = "none"; // ไม่ให้รับอีเวนต์การคลิก
                });
                // แสดง Popup ว่าไม่สามารถแก้ไข ticket ที่เสร็จแล้วได้
                    
            } else {
                // ถ้า ticket ยังเปิดให้ทำการเปิดการใช้งานปุ่มแก้ไขและปุ่มอื่น ๆ
                var editableButtons = document.querySelectorAll(".editable");
                editableButtons.forEach(function(button) {
                    button.disabled = false;
                     // เปิดการใช้งานปุ่ม
                });
            }
        });
        // ฟังก์ชันสำหรับการแสดงการแจ้งเตือน
        function showNotification(title, body) {
    if ("Notification" in window) {
        Notification.requestPermission().then(function(permission) {
            if (permission === "granted") {
                var notification = new Notification(title, {
                    body: body,
                    icon: "/static/favicon.ico"  // เส้นทางสัมพัทธ์ของไอคอน
                });
                notification.onclick = function() {
                    window.focus();  // เมื่อคลิกที่การแจ้งเตือน จะทำให้หน้าเว็บกลับมาโฟกัส
                };
            }
        });
    } else {
        console.warn("Notifications are not supported by this browser.");
    }
}

// ฟังก์ชันที่รับข้อมูลจาก Socket.IO และแสดงการแจ้งเตือน
socket.on('receive_chat', function(data) {
    const chatBox = document.getElementById(`chat_box_${data.ticket_id}`);
    
    if (chatBox) {
        // Create a new message element
        const newMessage = document.createElement('p');
        newMessage.id = `message_${data.message_id}`;
        newMessage.className = 'white-bg mt-1 mb-1 message-container zoom';
        
        newMessage.innerHTML = `
            ${data.image_user ? `<img src="${data.image_user}" alt="User Image" class="user-image-thumbnail" />` : ''}
            <strong>${data.sender}:</strong>
            ${data.message}
            ${data.image_path ? `<img src="${data.image_path}" class="chat-image-thumbnail image-container" onclick="viewFullImage('${data.image_path}')" />` : ''}
            <small>(${data.timestamp})</small>
            ${data.ticket_status === 'Pending' || data.ticket_status === 'in_progress' ? `<span class="delete-message small" onclick="deleteMessage('${data.message_id}')">delete</span>` : ''}
        `;
        
        // Optionally add a delete link for images
        if (data.image_path) {
            const deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-image-link';
            deleteLink.dataset.imageId = data.message_id;
            deleteLink.onclick = function(event) {
                deleteImage(event, data.image_path);
            };
            deleteLink.textContent = 'Delete';
            newMessage.appendChild(deleteLink);
        }
        
        // Append the new message to the chat box
        chatBox.appendChild(newMessage);
        
        // Optionally scroll to the bottom of the chat box
        chatBox.scrollTop = chatBox.scrollHeight;
    }
});
    </script>
    <script>
        function changeLanguage(lang) {
            // ส่งค่าภาษาไปยังหน้าเว็บที่ต้องการ
            window.location.href = `/${lang}/ticket_detial`; // เปลี่ยน URL ตามที่ต้องการ
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var ticketId = '{{ ticket.ticket_id }}'; // Reference the ticket_id variable from Python
            var reasonElement = document.getElementById("reason_" + ticketId);
            var closeButton = document.getElementById("closeButton");
    
            if (reasonElement) {
                var reasonValue = reasonElement.value;
                console.log("Reason Value:", reasonValue);
            } else {
                // Disable the "Close Ticket" button if the reason element is not found
                if (closeButton) {
                    closeButton.disabled = true;
                }
                console.log("Reason element not found");
            }
        });
    
        function submitForm(ticketId) {
            $('#successModal').modal('show');
        }
    
        function cant(ticketId) {
            event.preventDefault(); // Prevent page reload
            alert("This function can't use now.");   
            return; // Cancel ticket closure if no reason
        }
        
        function closeTicket(ticketId) {
            var reasonInput = document.getElementById("reason_" + ticketId);
            var reason = reasonInput ? reasonInput.value.trim() : '';

            // Get the Priority Issue Type value
            var priorityInput = document.getElementById("urgencyType_" + ticketId); // Updated ID for priority
            var priority = priorityInput ? priorityInput.value.trim() : '';

            // Get the Issue Type value
            var issueTypeInput = document.getElementById("issuetype_" + ticketId); // Updated ID for issue type
            var issueType = issueTypeInput ? issueTypeInput.value.trim() : '';

            // Check if reason is provided
            if (reason === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Please provide a reason',
                    text: 'Before closing the ticket.',
                    onClose: () => {
                        reasonInput.focus(); // Move cursor back to the input
                    }
                });
                return;
            }

            // Check if Priority Issue Type is provided
            if (priority === '' || priority.toLowerCase() === 'none') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Unable to Close Ticket',
                    text: 'Please set a valid Priority before closing the ticket.',
                    onClose: () => {
                        priorityInput.focus(); // Move cursor back to the input
                    }
                });
                return;
            }

            // Check if Issue Type is provided only if Priority is valid
            if (priority !== '' && issueType === 'None') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Unable to Close Ticket',
                    text: 'Please set a valid Issue Type before closing the ticket.',
                    onClose: () => {
                        issueTypeInput.focus(); // Move cursor back to the input
                    }
                });
                return;
            }
            // Show confirmation alert to close the ticket
            Swal.fire({
        title: 'Are you sure?',
        text: 'Do you want to close this ticket?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, I Finished it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // Create FormData to send to the server
            var formData = new FormData();
            formData.append("reason", reason);
            formData.append("priority", priority);
            formData.append("issueType", issueType);

            // Send request to the server to close the ticket
            fetch("/close/" + ticketId, {
                method: "POST",
                body: formData
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Show success alert after closing the ticket
                Swal.fire({
                    icon: 'success',
                    title: 'Ticket Closed',
                    text: 'The ticket has been closed successfully!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload(); // Refresh the page after successfully closing the ticket
                    }
                });
            })
            .catch(function(error) {
                console.error('Error:', error);
                // Show error alert when there is an issue closing the ticket
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'An error occurred while closing the ticket.'
                });
            });
        } else {
            Swal.fire("Cancelled", "Your ticket is Not Close :)", "error");
        }
    });
}
    </script>
    
<script>
    function showToast(message, duration = 5000) {
        const toastContainer = document.getElementById('toast-container');

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = message;

        const progressBar = document.createElement('div');
        progressBar.className = 'toast-progress';
        toast.appendChild(progressBar);

        toastContainer.appendChild(toast);

        setTimeout(function () {
            toast.classList.add('show');
            progressBar.style.width = '100%';

            setTimeout(function () {
                toast.remove();
            }, duration);
        }, 100);
    }

    // Example usage:
    $(document).ready(function () {
        // Show toast notification with progress bar
        showToast('This is a toast notification with progress!', 5000);
    });
</script>

        <script>
            function submitForm() {
                document.getElementById("status-form").submit();
            }
            function saveReason(ticketId) {
                var reasonInput = document.getElementById("reason_" + ticketId);
                var reason = reasonInput.value.trim();

                // หยุดการส่งคำขอโดยอัตโนมัติ
                event.preventDefault();

                // ส่งคำขอโดยใช้ AJAX
                $.ajax({
                    type: "POST",
                    url: "/status/" + ticketId + "/submit",
                    data: { reason: reason },
                    success: function(response) {
                        // ตรวจสอบการตอบสนอง
                        if (response.status == "success") {
                            // แสดง SweetAlert หลังจากบันทึกสำเร็จ
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Solution saved successfully!'
                            }).then(() => {
                                // รีเฟรชหน้าเว็บ
                                window.location.reload();
                            });
                        } else {
                            // แสดง SweetAlert หากมีข้อผิดพลาด
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Solution saved successfully!'
                            }).then(() => {
                                // รีเฟรชหน้าเว็บ
                                window.location.reload();
                            });
                        }
                    },
                    error: function() {
                        // แสดง SweetAlert หากมีข้อผิดพลาด
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'An error occurred while saving the Solution.'
                        }).then(() => {
                            // รีเฟรชหน้าเว็บ
                            window.location.reload();
                        });
                    }
                });
            }



            function handleImageUpload(event, ticketId) {
                var input = event.target;
                var file = input.files[0];
                var reader = new FileReader();

                reader.onload = function(e) {
                    var previewImage = document.getElementById('previewImage_' + ticketId);
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };

                reader.readAsDataURL(file);
            }

            function sendChat(ticketId) {
                const messageInput = document.getElementById(`chat_${ticketId}`);
                const message = messageInput.value.trim();
                const imageInput = document.getElementById(`singleImageUpload_${ticketId}`);  // Updated ID
                const imageFile = imageInput.files[0];
                const formData = new FormData();
                const username = "{{ current_user.displayname }}";

                formData.append("ticket_id", ticketId);
                formData.append("message", message);
                formData.append("sender", username);

                if (imageFile) {
                    formData.append("image", imageFile);
                }

                if (message || imageFile) {
                    fetch("/send_chat", {
                        method: "POST",
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Bad request');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            messageInput.value = '';
                            imageInput.value = '';
                            document.getElementById(`previewImage_${ticketId}`).style.display = 'none';
                        } else {
                            throw new Error(data.error || 'Failed to send message');
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("An error occurred while sending the message.");
                    });
                } else {
                    alert("Please enter a message or upload an image.");
                }
            }


            function viewFullImage(src) {
                var modal = document.getElementById('fullImageModal');
                var img = document.getElementById('fullImage');
                modal.style.display = 'block';
                img.src = src;
            }

            function closeFullImage() {
                var modal = document.getElementById('fullImageModal');
                modal.style.display = 'none';
            }

            function updateChatLog(ticketId) {
                fetch('/update_chat/' + ticketId)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            var chatLogElement = document.getElementById('chat_log_' + ticketId);
                            if (chatLogElement) {
                                chatLogElement.innerHTML = data.updatedChatLog;
                            } else {
                                console.error('Element chat_log_' + ticketId + ' not found');
                            }
                        } else {
                            console.error('Failed to update chat log');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating chat log:', error);
                    });
            }

            function deleteMessage(messageId) {
                Swal.fire({
                    icon: 'question',
                    title: 'Are you sure?',
                    text: 'Are you sure you want to delete this message?',
                    showCancelButton: true,
                    confirmButtonText: 'Delete',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/delete_message/${messageId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                document.getElementById(`message_${messageId}`).remove();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Message deleted successfully!',
                                    onClose: () => {
                                        window.location.reload();
                                    }
                                });
                            } else {
                                response.json().then(data => {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Failed to delete message: ' + data.error
                                    });
                                });
                            }
                        })
                        .catch(error => {
                            console.error("Error deleting message:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred while deleting the message.'
                            });
                        });
                    }
                });
            }



            function deleteImage(event, imagePath) {
                event.preventDefault(); // ป้องกันการโหลดหน้าใหม่

                Swal.fire({
                    icon: 'question',
                    title: 'Are you sure?',
                    text: 'Are you sure you want to delete this image?',
                    showCancelButton: true,
                    confirmButtonText: 'Delete',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // ส่งคำขอลบไฟล์ภาพไปยังเซิร์ฟเวอร์
                        fetch('/delete_image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ image_path: imagePath })
                        })
                        .then(response => {
                            if (response.ok) {
                                // ลบรูปภาพจาก DOM หลังจากลบสำเร็จ
                                var imageElement = event.target.previousElementSibling;
                                imageElement.parentNode.removeChild(imageElement);
                                event.target.parentNode.removeChild(event.target);
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Image deleted successfully!',
                                    onClose: () => {
                                        window.location.reload();
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to delete image'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting image:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred while deleting the image'
                            });
                        });
                    }
                });
            }

            function resizeImage(imageData, maxWidth, maxHeight, callback) {
                var img = new Image();
                img.onload = function() {
                    var width = img.width;
                    var height = img.height;

                    // Check if resizing is needed
                    if (width > maxWidth || height > maxHeight) {
                        var ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }

                    // Create a canvas element
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');

                    // Set canvas dimensions to resized dimensions
                    canvas.width = width;
                    canvas.height = height;

                    // Draw image on canvas
                    ctx.drawImage(img, 0, 0, width, height);

                    // Get resized image data
                    var resizedImageData = canvas.toDataURL('image/jpeg');

                    // Call the callback with resized image data
                    callback(resizedImageData);
                };
                // Set image source to the base64-encoded image data
                img.src = imageData;
            }
            function handlePaste(event) {
                const clipboardItems = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (const item of clipboardItems) {
                    if (item.kind === 'file' && item.type.includes('image')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageData = event.target.result;
                            uploadImageFromData(imageData);
                        };
                        reader.readAsDataURL(blob);
                    }
                }
            }

            function displayImageInChat(imageUrl) {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value += `<img src="${imageUrl}" class="chat-image-thumbnail" onclick="viewFullImage('${imageUrl}')"/>`;
            } else {
                console.error('Textarea element not found');
            }
        }

    </script>
<script>
    // Polyfill for crypto.randomUUID
    if (!crypto.randomUUID) {
        crypto.randomUUID = function() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 0x0f) >> 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        };
    }

    function handlePaste(event, errorId) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageData = event.target.result;
                    uploadImageFromData(imageData, errorId);
                };
                reader.readAsDataURL(file);
            }
        }
    }

    function handleImageUpload(event, errorId) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const imageData = event.target.result;
            
            uploadImageFromData(imageData, errorId);
        };
        reader.readAsDataURL(file);
    }

    function uploadImageFromData(imageData, errorId) {
        fetch('/upload_image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ imageData: imageData, errorId: errorId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
                displayImageInChat(data.imageUrl, errorId);
            } else {
                console.error('Failed to upload image:', data.error);
            }
        })
        .catch(error => {
            console.error('Error uploading image:', error);
        });
    }

    function displayImageInChat(imageUrl, errorId) {
        const chatDiv = document.querySelector('.chat');
        const p = document.createElement('p');
        p.classList.add('white-bg', 'mt-1', 'mb-1', 'message-container');

        const img = document.createElement('img');
        img.src = imageUrl;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => viewFullImage(imageUrl);

        p.appendChild(img);
        chatDiv.appendChild(p);
    }
    var currentImageIndex = 0;
var images = []; // เก็บรายชื่อภาพ

function viewFullImage(src) {
    var modal = document.getElementById("imageModal");
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");

    // เพิ่มภาพใน array และตั้งค่า index
    images = []; // ล้าง array ก่อน
    document.querySelectorAll('.chat-image-thumbnail').forEach(img => {
        images.push(img.src);
    });

    currentImageIndex = images.indexOf(src);

    modal.style.display = "flex"; // ใช้ flexbox เพื่อให้ modal อยู่กลางจอ
    modalImg.src = src;
    captionText.innerHTML = ""; // ใส่คำบรรยายถ้าต้องการ
}
// Close the modal
function closeModal() {
    document.getElementById("imageModal").style.display = "none";
}
window.onclick = function(event) {
    var modal = document.getElementById("imageModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// Change image when clicking on navigation buttons
function changeImage(n) {
    currentImageIndex += n;
    if (currentImageIndex >= images.length) currentImageIndex = 0;
    if (currentImageIndex < 0) currentImageIndex = images.length - 1;
    
    var newImageSrc = images[currentImageIndex];
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");
    
    modalImg.src = newImageSrc;
    captionText.innerHTML = "Image " + (currentImageIndex + 1) + " of " + images.length;
}


    function edit(event, orderId) {
        event.preventDefault(); // Prevent form submission
        alert("Coming soon. This function is not available now.");
        window.location.reload();
    }
</script>
<script>
    // Function สำหรับบันทึก issuetype ไปยังฐานข้อมูล
    // Function to save issue type to the database
    // Function สำหรับแสดง Modal แจ้งเตือนเมื่อมีการบันทึกประเภทปัญหา

// Function สำหรับบันทึกประเภทปัญหาไปยังเซิร์ฟเวอร์
function saveIssueType(ticketId, issueType) {
        const subtypeElement = document.querySelector(`#subtypeDropdown_${ticketId} select`);
        const subtype = subtypeElement ? subtypeElement.value : null; // ดึงค่า subtype ที่เลือก

        const data = {
            ticket_id: ticketId,
            issuetype: issueType,
            subtype: subtype // ส่ง subtype ด้วย
        };

        fetch(`/save_issue_type/${ticketId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Issue type and subtype updated successfully!',
                onClose: () => {
                    const updatedIssueTypeElement = document.getElementById(`issuetype_${ticketId}`);
                    if (updatedIssueTypeElement) {
                        updatedIssueTypeElement.textContent = issueType + (subtype ? ` - ${subtype}` : '');
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error updating issue type:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to update issue type'
            });
        });
    }




    function setUrgency(ticketId, urgencyType) {
        const data = {
            ticket_id: ticketId,
            type: urgencyType
        };

        fetch(`/set_urgency/${ticketId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Urgency updated successfully!',
                onClose: () => {
                    const updatedUrgencyElement = document.getElementById(`updatedUrgency${ticketId}`);
                    if (updatedUrgencyElement) {
                        updatedUrgencyElement.textContent = urgencyType;
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error updating urgency:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to update urgency'
            });
        });
    }
    async function handleMultipleImageUpload(event, ticketId) {
    const input = event.target;
    const previewContainer = document.getElementById(`previewContainer_${ticketId}`);
    
    if (previewContainer) {
        previewContainer.innerHTML = ''; // Clear previous previews

        if (input.files) {
            showUploadModal(); // Show upload modal

            // Create an array to store image data
            const imageDataArray = [];

            // Function to process a file
            const processFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100px';
                        img.style.margin = '5px';
                        previewContainer.appendChild(img);

                        // Prepare image data
                        const imageData = {
                            ticketId: ticketId,
                            imageData: e.target.result
                        };

                        imageDataArray.push(imageData);

                        resolve();
                    };

                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
            };

            // Create an array of promises for each file
            const filePromises = Array.from(input.files).map(file => processFile(file));

            // Process all files concurrently
            try {
                await Promise.all(filePromises);

                // Send all images to the server
                const response = await fetch('/upload_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ images: imageDataArray })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.success) {
                    console.log('Images uploaded successfully:', data.messages);
                } else {
                    console.error('Image upload failed:', data.error);
                }
            } catch (error) {
                console.error('Error uploading images:', error);
            }

            // Close the upload modal after all images are uploaded
            closeUploadModal();
        }
    }
}



var currentImageIndex = 0;
var images = []; // เก็บรายชื่อภาพ

function showUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function viewFullImage(src) {
    var modal = document.getElementById("imageModal");
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");

    // เพิ่มภาพใน array และตั้งค่า index
    images = []; // ล้าง array ก่อน
    document.querySelectorAll('.chat-image-thumbnail').forEach(img => {
        images.push(img.src);
    });

    currentImageIndex = images.indexOf(src);

    modal.style.display = "flex"; // ใช้ flexbox เพื่อให้ modal อยู่กลางจอ
    modalImg.src = src;
    captionText.innerHTML = ""; // ใส่คำบรรยายถ้าต้องการ
}

function closeModal() {
    var modal = document.getElementById("imageModal");
    modal.style.display = "none";
}

function zoomIn() {
    var modalImg = document.getElementById("modalImage");
    scale += 0.1;
    modalImg.style.transform = "scale(" + scale + ")";
}

function zoomOut() {
    var modalImg = document.getElementById("modalImage");
    scale = Math.max(scale - 0.1, 1); // จำกัดไม่ให้ scale น้อยกว่า 1
    modalImg.style.transform = "scale(" + scale + ")";
}

function changeImage(step) {
    var modalImg = document.getElementById("modalImage");
    currentImageIndex = (currentImageIndex + step + images.length) % images.length;
    modalImg.src = images[currentImageIndex];
}

// ปิด modal เมื่อคลิกนอก modal
window.onclick = function(event) {
    var modal = document.getElementById("imageModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}


</script> 
<script>
function handleIssueSelection(ticketId, issueType) {
    // Issue types that don't need to show the subtype dropdown
    const noSubtypeTypes = ['OtherIssue', 'User', 'CCTV', 'UPS'];

    // Get the subtype dropdown element
    var subtypeDropdown = document.getElementById('subtypeDropdown_' + ticketId);
    var subtypeSelect = document.getElementById('subtype_' + ticketId); // Get the subtype select element

    if (noSubtypeTypes.includes(issueType)) {
        // Hide the subtype dropdown if the issue type doesn't need a subtype
        subtypeDropdown.style.display = 'none';
        
        // Clear the subtype field by setting it to the default option
        subtypeSelect.innerHTML = `<option value="">--Select Subtype--</option>`;
        
        // Immediately save the issue type without showing the subtype dropdown
        saveIssueType(ticketId, issueType); 
    } else {
        // Show the subtype dropdown for other issue types
        subtypeDropdown.style.display = 'block';
        
        // Update the subtype dropdown with corresponding options
        updateSubtypeDropdown(ticketId, issueType);
    }
}


function updateSubtypeDropdown(ticketId, issueType) {
    var subtypeDropdown = document.getElementById('subtypeDropdown_' + ticketId);
    var subtypeHTML = '';
        switch (issueType) {
            case 'Hardware':
                subtypeHTML = `
                    <label for="subtype_hardware_${ticketId}"><strong>Select Hardware Issue: </strong></label>
                    <select id="subtype_hardware_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'Hardware')">
                        <option value="">--Select--</option>
                        <option value="Monitor">Monitor</option>
                        <option value="Keyboard">Keyboard</option>
                        <option value="Mouse">Mouse</option>
                        <option value="CPU">CPU</option>
                        <option value="RAM">RAM</option>
                        <option value="HDD">HDD</option>
                        <option value="SSD">SSD</option>
                        <option value="PSU">PSU</option>
                        <option value="MotherBoard">MotherBoard</option>
                        <option value="Camera">Camera</option>
                        <option value="Scan Barcode">Scan Barcode</option>
                    </select>`;
                break;
            case 'Software':
                subtypeHTML = `
                    <label for="subtype_software_${ticketId}"><strong>Select Software Issue: </strong></label>
                    <select id="subtype_software_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'Software')">
                        <option value="">--Select--</option>
                        <option value="Excel">Excel</option>
                        <option value="Outlook">Outlook</option>
                        <option value="Word">Word</option>
                        <option value="PowerPoint">PowerPoint</option>
                        <option value="Adobe">Adobe</option>
                        <option value="Windows"">Windows</option>
                        <option value="Antivirus">Antivirus</option>
                        <option value="Driver etc">Driver etc</option>
                    </select>`;
                break;
            case 'Network':
                subtypeHTML = `
                    <label for="subtype_network_${ticketId}"><strong>Select Network Issue: </strong></label>
                    <select id="subtype_network_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'Network')">
                        <option value="">--Select--</option>
                        <option value="LAN">LAN</option>
                        <option value="Internet">Internet</option>
                        <option value="Switch">Switch</option>
                        <option value="Hub">Hub</option>
                    </select>`;
                break;
            case 'FingerScan':
                subtypeHTML = `
                    <label for="subtype_fingerscan_${ticketId}"><strong>Select FingerScan Issue: </strong></label>
                    <select id="subtype_fingerscan_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'FingerScan')">
                        <option value="">--Select--</option>
                        <option value="AddFingerScan">Add FingerScan</option>
                        <option value="FixFingerScan">Fix FingerScan</option>
                        <option value="DeleteFingerScan">Delete FingerScan</option>
                        <option value="DeleteFingerScan">Add or Remove current finger</option>
                    </select>`;
                break;
            case 'Printer':
                subtypeHTML = `
                    <label for="subtype_printer_${ticketId}"><strong>Select Printer Issue: </strong></label>
                    <select id="subtype_printer_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'Printer')">
                        <option value="">--Select--</option>
                        <option value="Add Printer">Add Printer</option>
                        <option value="Remove Printer">Remove Printer</option>
                        <option value="Change Printer">Change Printer</option>
                        <option value="InkProblem">Ink Problem</option>
                        <option value="ConnectionProblem">Connection Problem</option>
                        <option value="DriverProblem">Driver Problem</option>
                    </select>`;
                break;
            case 'Server':
                subtypeHTML = `
                    <label for="subtype_server_${ticketId}"><strong>Select Server Issue: </strong></label>
                    <select id="subtype_server_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'Server')">
                        <option value="">--Select--</option>
                        <option value="Sharefile">Sharefile Issue</option>
                        <option value="Navision">Navision Issue</option>
                        <option value="AddPermission">Add Permission Issue</option>
                    </select>`;
                break;
            case 'IP Phone':
                subtypeHTML = `
                    <label for="subtype_ipphone_${ticketId}"><strong>Select IP Phone Issue: </strong></label>
                    <select id="subtype_ipphone_${ticketId}" style="width: 200px; height: 40px;"onchange="saveIssueType('${ticketId}', 'IP Phone')">
                        <option value="">--Select--</option>
                        <option value="ChangeNew">Change New</option>
                        <option value="ResetSetting">Reset Setting</option>
                    </select>`;
                    break;
        default:
            subtypeHTML = `<option value="">--Select Subtype--</option>`;
    }

    subtypeDropdown.innerHTML = subtypeHTML;
}
   
    </script> 
<!-- Include SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<!-- Include SweetAlert JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

</body>
</html>

